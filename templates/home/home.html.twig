{% extends 'base.html.twig' %}

{% block body %}
    <div class="container">
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label }}">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
            {% endfor %}
        {% endfor %}

        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h2 class="card-title">Bienvenue{% if app.user %}, {{ app.user.username }}{% endif %}</h2>
                        <p>Vous êtes connecté à votre espace d'expression personnel.</p>
                        <p>N'hésitez pas à partager vos pensées ou à interagir avec la communauté.</p>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h3 class="card-title">Partagez vos pensées</h3>
                        <form method="post" action="{{ path('app_post_new') }}">
                            <div class="form-group">
                                <textarea class="form-control" name="content" rows="4" placeholder="Exprimez-vous..." required></textarea>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="is_anonymous" id="is_anonymous">
                                <label class="form-check-label" for="is_anonymous">Publier anonymement</label>
                            </div>
                            <input type="hidden" name="_token" value="{{ csrf_token('post_new') }}">
                            <button type="submit" class="btn btn-primary mt-2">Publier</button>
                        </form>
                    </div>
                </div>

                <h3>Publications récentes</h3>
                {% for post in recentPosts %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>{{ post.isAnonymous ? 'Anonyme' : (post.author ? post.author.username : 'Utilisateur inconnu') }}</strong>
                            <span class="text-muted">{{ post.createdAt|ago }}</span>
                            {% if is_granted('ROLE_ADMIN') or (app.user and post.author and post.author.id == app.user.id) %}
                                <form method="post" action="{{ path('app_post_delete', {'id': post.id}) }}" onsubmit="return confirm('Voulez-vous vraiment supprimer cette publication ?');" class="d-inline">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ post.id) }}">
                                    <button type="submit" class="btn btn-danger btn-sm float-right">Supprimer</button>
                                </form>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <p>{{ post.content }}</p>

                            {% set userLiked = false %}
                            {% set userSupported = false %}
                            {% set userMeToo = false %}
                            {% set likeCount = 0 %}
                            {% set supportCount = 0 %}
                            {% set meTooCount = 0 %}

                            {% for reaction in post.reactions %}
                                {% if reaction.type == 'like' %}
                                    {% set likeCount = likeCount + 1 %}
                                    {% if app.user and reaction.user and reaction.user.id == app.user.id %}
                                        {% set userLiked = true %}
                                    {% endif %}
                                {% elseif reaction.type == 'support' %}
                                    {% set supportCount = supportCount + 1 %}
                                    {% if app.user and reaction.user and reaction.user.id == app.user.id %}
                                        {% set userSupported = true %}
                                    {% endif %}
                                {% elseif reaction.type == 'me_too' %}
                                    {% set meTooCount = meTooCount + 1 %}
                                    {% if app.user and reaction.user and reaction.user.id == app.user.id %}
                                        {% set userMeToo = true %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            <div class="mt-2">
                                <a href="{{ path('app_post_react', {'id': post.id, 'type': 'like'}) }}" class="btn btn-outline-primary btn-sm {{ userLiked ? 'disabled' : '' }}">{{ likeCount }} J'aime</a>
                                <a href="{{ path('app_post_react', {'id': post.id, 'type': 'support'}) }}" class="btn btn-outline-success btn-sm {{ userSupported ? 'disabled' : '' }}">{{ supportCount }} Soutien</a>
                                <a href="{{ path('app_post_react', {'id': post.id, 'type': 'me_too'}) }}" class="btn btn-outline-info btn-sm {{ userMeToo ? 'disabled' : '' }}">Moi aussi ({{ meTooCount }})</a>
                            </div>

                            <div class="mt-3">
                                <h5>Commentaires ({{ post.comments|length }})</h5>
                                {% for comment in post.comments %}
                                    <div class="card mb-2">
                                        <div class="card-header">
                                            <strong>{{ comment.author ? comment.author.username : 'Utilisateur inconnu' }}</strong>
                                            <span class="text-muted">{{ comment.createdAt|ago }}</span>
                                            {% if is_granted('ROLE_ADMIN') or (app.user and comment.author and comment.author.id == app.user.id) %}
                                                <form method="post" action="{{ path('app_comment_delete', {'id': comment.id}) }}" onsubmit="return confirm('Voulez-vous vraiment supprimer ce commentaire ?');" class="d-inline">
                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ comment.id) }}">
                                                    <button type="submit" class="btn btn-danger btn-sm float-right">Supprimer</button>
                                                </form>
                                            {% endif %}
                                        </div>
                                        <div class="card-body">
                                            <p>{{ comment.content }}</p>

                                            {% set userLiked = false %}
                                            {% set likeCount = 0 %}
                                            {% for reaction in comment.reactions %}
                                                {% if reaction.type == 'like' %}
                                                    {% set likeCount = likeCount + 1 %}
                                                    {% if app.user and reaction.user and reaction.user.id == app.user.id %}
                                                        {% set userLiked = true %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}

                                            <a href="{{ path('app_comment_react', {'id': comment.id, 'type': 'like'}) }}" class="btn btn-outline-primary btn-sm {{ userLiked ? 'disabled' : '' }}">{{ likeCount }} J'aime</a>
                                        </div>
                                    </div>
                                {% endfor %}

                                <form method="post" action="{{ path('app_comment_new', {'post_id': post.id}) }}" class="mt-3">
                                    <div class="form-group">
                                        <textarea class="form-control" name="content" rows="2" placeholder="Votre commentaire..." required></textarea>
                                    </div>
                                    <input type="hidden" name="_token" value="{{ csrf_token('comment_new') }}">
                                    <button type="submit" class="btn btn-primary btn-sm">Envoyer</button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title">Expériences similaires</h3>
                        <p>Découvrez des témoignages de personnes ayant vécu des expériences similaires aux vôtres.</p>
                        {% if categories|length > 0 %}
                            <ul class="list-group list-group-flush">
                                {% for category in categories %}
                                    <li class="list-group-item">{{ category.name }}</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucune catégorie disponible pour le moment.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 text-center">
        <p>© {{ 'now'|date('Y') }} Espace d'Expression - Un lieu pour s'exprimer librement</p>
    </footer>
{% endblock %}